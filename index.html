<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">

  <title>TGRASS: temporal data processing with GRASS GIS</title>
  <meta name="description" content="">
  <meta name="author" content="">
  <link rel="shortcut icon" href="grass.png">

  <script src="lib/jquery.js"></script>

<!--
<link rel="stylesheet" href="http://yandex.st/highlightjs/8.0/styles/default.min.css">
<script src="http://yandex.st/highlightjs/8.0/highlight.min.js"></script>
-->

<link rel="stylesheet" href="lib/highlights/styles/default.css">
<script src="lib/highlights/highlight.pack.js"></script>


<style>
.hljs{
    display: none;
    /*padding: 0em;*/
}
</style>


  <link rel="stylesheet" href="css/grassdocs.css">
  <link rel="stylesheet" href="css/codetabs.css">

</head>

<body>

  <div id="container">
    <a href="https://europe.foss4g.org/2017/" title="FOSS4G EU 2017"><img src="foss4g_eu_2017.png" width="22%" height="22%" align="left" alt="FOSS4G EU 2017 logo"></a><a href="http://grass.osgeo.org" title="GRASS GIS"><img src="grassgis_logo_colorlogo_text_whitebg.png" width="19%" height="19%" align="right" alt="GRASS GIS logo"></a><h1 align="center">TGRASS: temporal data processing with GRASS GIS</h1>
    <h2 class="notoc" align="center">FOSS4G Europe 2017 workshop</h2>
    <p align="center">
    Veronica Andreo, Luca Delucchi and Markus Neteler
    </p>
    <p style="border-top-style: solid; border-bottom-style: solid; border-width: 5px; border-color: rgb(130, 130, 130); padding-top: 5px;">
<!--
	meter una animacion de NC
-->
    </p>
    <p>
    Outline:
    <ul>
    <li>Introduction to GRASS GIS</li>
    <li>Introduction to GRASS Temporal Framework</li>
<!--
	links to "traditional" presentations for both introductions (?)
-->
    <li>Hands-on to raster time series processing
    </ul>
    <p>
    Software:
    <ul>
    <li>GRASS GIS 7.2</li>
    <li>GRASS GIS Add-ons: <a href="https://grass.osgeo.org/grass72/manuals/addons/r.modis.download.html">r.modis.download</a>,  
    <a href="https://grass.osgeo.org/grass72/manuals/addons/r.modis.import.html">r.modis.import</a> and 
    <a href="https://grass.osgeo.org/grass72/manuals/addons/v.strds.stats.html">v.strds.stats</a></li>
    <li> <a href="http.pyModis.org">pyModis</a> </li>
<!--
	<li>matplotlib with pyplot
	(included in GRASS installation for MS Windows; package python-matplotlib for Ubuntu)</li>
-->
    </ul>
    <p>
    Data:
    <ul>
    <li>location <a href="https://grass.osgeo.org/sampledata/north_carolina/nc_spm_08_grass7.tar.gz">NC basic (50 MB)</a>
    <ul>
    <li>mapset <code>modis_lst</code>: monthly land surface temperature (LST) from MODIS sensor (MOD11B3.006) for North Carolina (2015-2016)</li>
    </ul>
    </ul>
    <h2>GRASS GIS introduction</h2>
    <h3>General GRASS GIS introduction</h3>
    <p>
    Location, Mapset, Region
    <p>
    General overview of modules
    <p>
    Raster and vector maps
    <p>
    Nulls and Mask
    <h3>Temporal GRASS GIS introduction</h3>
    <p>
    <h4>GRASS GIS as a Temporal GIS</h4>
    <p>
<!--
        First TGIS Open Source with capabilities to manage, analyze, 
        process and visualize spatio-temporal data, as well as, the 
        temporal relationships among time series.
        
        TGRASS concept is based on metadata. It uses an SQL database to 
        store temporal and spatial extension of STDS, maps and maps 
        metadata, as well as the topological relationships among maps 
        and among STDS
-->
    <h4>Terminology overview</h4>
    <p>
    <h5>Temporal database</h5>
    <p>
    <h5>Space-time datasets</h5>
    <ul>
    <li>Space time raster datasets (<b>STRDS</b>) are designed to hold raster map time series. 
    Modules that process strds are named with the prefix <em>t.rast.*</em></li>
    <li>Space time 3D raster datasets (<b>STR3DS</b>) are designed to hold 3D raster map time series. 
    Modules that process str3ds are named with the prefix <em>t.rast3d.*</em></li>
    <li>Space time vector datasets (<b>STVDS</b>) are designed to hold vector map time series. 
    Modules that process stvds are named with the prefix <em>t.vect.*</em></li>
    </ul>
    <p>
    <h5>Absolute time vs relative time</h5>
    <p>
<!--
        Absolute time
        Gregorian calendar (ISO 86012 time format notation) 
        Example: 2013-10-15 13:00:00
        
        Relative time
        An integer and a unit (year, month, day, hour, minute, seconds). 
        Example: 4 years, 90 days, 1 second 
-->
    <h5>Time intervals vs time instances</h5>
    <p>
<!--
Time intervals
Support for gaps
Allows overlapping
Might contain time instances
Irregularly spaced in time
Defined by start time and end time: 
[start, end)

Time instances
Punctual event
Defined by start time
-->
    <h5>Granularity</h5>
    <p>
<!--
        The largest common divider granule of time intervals and gaps 
        between intervals or instances from all time stamped spatial 
        fields that are collected in a STDS. It is represented as a 
        number of seconds, minutes, hours, days, weeks, months or years.
-->
    <h4>Workflow overview</h4>
    <ol>
    <li>t.connect</li>
    <li>t.create</li>
    <li>t.register</li>
    <li>t.info, t.list, t.rast|vect.list</li>
    <li>Analysis: t.rast.series, t.rast.aggregate, t.rast.accumulate, t.rast.algebra, etc.</li> 
<!--
1. Set and connect the temporal database: t.connect
2. Creation of the STDS: t.create
3. Registering maps in the STDS: t.register
4. Check info, integrity and validity of STDS: t.list, t.info, t.topology
4'. Edition, updating, removal of maps and/or STDS: t.remove, t.support
5. Listing maps, selections, univariate statistics: t.rast.list/t.vect.list, t.rast.univar/t.vect.univar, t.select, t.rast.extract/t.vect.extract, etc.
6. Spatio-temporal processing: aggregations, accumulations, smoothing, gap-filling, spatio-temporal algebra, etc.
7. Visualization
8. Exporting 
-->
    </ol>
    <h2>Hands-on to raster time series processing</h2>
    <h3>Get MODIS data</h3>
    Create the <i>SETTING</i> file with the following content:
    <p>
    your_NASA_user
    your_NASA_password
<pre><code class="neutral">
# Download data: MOD11B3 2015-2016, tile h11v05 
r.modis.download -g settings=$HOME/gisdata/SETTING \
product=lst_terra_monthly_5600 \
tiles=h11v05 startday="2015-01-01" endday="2016-12-31" \
folder=$HOME/lst_monthly
  
# Reproject and import maps into NC Location (Day and Night)
r.modis.import -w files=$HOME/lst_monthly/listfileMOD11B3.006.txt \
spectral="( 1 1 0 0 1 1 )" \
outfile=$HOME/lst_monthly/monthly_lst_to_register.txt

# Check list of imported maps
g.list type=raster patern="MOD11B3*"
</code></pre>
<p>bla bla bla</p>
<p>
<pre><code class="neutral">
# Visualize one image and add map decorations
# change color palette
r.colors MOD11B3.A2015060.h11v05.single_LST_Day_6km color=viridis
# set region to NC (g.region -d)
g.region vector=nc_state
# optionally, to the full extent of one of the raster maps
g.region raster=MOD11B3.A2015060.h11v05.single_LST_Day_6km
# open a monitor
d.mon wx0
# display raster
d.rast map=MOD11B3.A2015060.h11v05.single_LST_Day_6km
# display vector
d.vect map=nc_state type=boundary
# add raster legend
d.legend -t -s -d -b raster=MOD11B3.A2015060.h11v05.single_LST_Day_6km \
title=LST title_fontsize=20 font=sans fontsize=18
# add scale bar
d.barscale length=200 units=kilometers segment=4 fontsize=14
# add north arrow
d.northarrow style=1b text_color=black
# add text
d.text -b text="LST Day from MOD11B3.006 - North Carolina - March, 2015" \
color=black bgcolor=229:229:229 align=cc font=sans size=8
</code>
</pre>
<p style="text-align:center">
<img style="width: 600px;" src="figures/mod11b3_nc.png" alt="display LST map with decorations" title="display LST map with decorations">
</p>

<h3>Create temporal dataset (STRDS)</h3>
<pre><code class="neutral">
# Create the temporal db connection
t.connect -d

# Create STRDS
t.create type=strds temporaltype=absolute output=LST_Day_monthly \
 title="Monthly LST Day 5.6 km" \
 description="Monthly LST Day 5.6 km MOD11B3.006, 2015-2016"

# Check if the STRDS is created
t.list type=strds
t.info input=LST_Day_monthly

# Register maps in STRDS
t.register input=LST_Day_monthly \
 file=$HOME/lst_monthly/monthly_lst_to_tregister.txt

t.info LST_Day_monthly
t.rast.list LST_Day_monthly
g.gui.timeline -3 inputs=LST_Day_monthly

# plot here

# alternatively
t.register -i input=LST_Day_monthly \
 maps=`g.list type=raster pattern=MOD11B3* separator=comma` \
 start="2015-01-01" increment="1 month"

# for more options to register maps: https://grasswiki.osgeo.org/wiki/Temporal_data_processing/maps_registration
</code></pre>
<h3>Temporal data analysis</h3>
<p>
<pre><code class="neutral">
# set a color table for the strds
t.rast.color input=LST_Day_monthly color=viridis

# summary stats for maps within STRDS
t.rast.univar input=cla separator=comma output=stats_cla.csv

# from kelvin to celsius
t.rast.algebra basename=LST_Day_monthly_celsius \
 expression="LST_Day_monthly_celsius = (LST_Day_monthly*0.02) - 273.15"

t.rast.color input=LST_Day_monthly color=celsius
</code></pre>

<pre><code class="neutral">
# Listing maps in STRDS

# maps with minimum value lower than or equal to 14000
t.rast.list input=LST_Day_monthly_celsius order=min \
columns=id,name,start_time,min where="min <= '14000'" 

# maps with maximum value higher than 14000
t.rast.list input=LST_Day_monthly_celsius order=max \
columns=name,start_time,max where="max > '14000'"

# maps between the given dates
t.rast.list input=LST_Day_monthly_celsius \
where="start_time >= '2015-03' and start_time <= '2016-01'" 

# maps from January
t.rast.list input=LST_Day_monthly_celsius \
where="strftime('%m', start_time)='01'"

# maps from January, 1st
t.rast.list input=LST_Day_monthly_celsius \
where="strftime('%m-%d', start_time)='01-01'"

# maps corresponding to Mondays (Sunday is 0)
t.rast.list input=LST_Day_monthly_celsius \
where="strftime('%w', start_time)='1'"
</code></pre>

# Aggregations

<pre><code class="neutral">
# max LST 
t.rast.series input=LST_Day_monthly_celsius \
output=LST_Day_max_2015_2016 \
method=maximum

# 3-month mean
t.rast.aggregate input=LST_Day_monthly_celsius \
output=LST_Day_mean_3month \
basename= suffix=gran \
method= granularity=

# 6-month mean
t.rast.aggregate input=LST_Day_monthly_celsius \
output=LST_Day_mean_6month \
basename= suffix=gran \
method= granularity=
</code></pre>

# Spatio-temporal algebra: Get the month of maximum LST

<pre><code class="neutral">
# new strds with DOY of overall maximum 
t.rast.mapcalc -n inputs=LST_Day_monthly_celsius output=month_max_lst \
expression="if(LST_Day_monthly_celsius == LST_Day_max_2015_2016, start_month(), null())" \
basename=month_max_lst

# map with month of overall maximum
t.rast.series input=month_max_lst method=maximum output=max_lst_date

# remove date_max_cla strds (we were only interested in the resulting aggregated map)
t.remove -rf inputs=month_max_cla

# display
d.mon wx0
d.rast max_lst_date
</code></pre>


<pre><code class="neutral">
# Extract strds values for points in a vector
v.what.strds input=comm_colleges strds= output=
v.db.select map= file=ts_points.csv

# alternatively:
t.rast.what points=points strds=cla output=cla_points.csv null_value=NA separator=comma

# Extract strds statistics for a polygons vector
v.strds.stats input=boundary_municp strds=LST_Day_monthly_celsius \
output= method=average,minimum,maximum
v.db.select map= file=ts_polygons.csv
</code></pre>

</p>
<h3>Temporal data visualization</h3>
<pre><code class="neutral">
g.gui.mapswipe
g.gui.animation
g.gui.tplot
</code></pre>
<h2>Other (very) useful links</h2>
<ul>
<li> <href>https://ncsu-osgeorel.github.io/grass-intro-workshop/</href></li>
<li>https://grasswiki.osgeo.org/wiki/Unleash_the_power_of_GRASS_GIS_at_US-IALE_2017</li>
<li>https://grasswiki.osgeo.org/wiki/Temporal_data_processing</li>
<li>http://ncsu-geoforall-lab.github.io/grass-temporal-workshop/</li>
<li>https://grasswiki.osgeo.org/wiki/Temporal_data_processing/GRASS_R_raster_time_series_processing</li>
</ul>
<h2>References</h2>
Gebbert, S., Pebesma, E. (2014). <em>A temporal GIS for field based environmental modeling</em>. Environmental Modelling & Software, 53, 1â€“12.<br>
Gebbert, S., Pebesma, E. (2017). <em>The GRASS GIS temporal framework</em>. International Journal of Geographical Information Science 31, 1273-1292.<br>
<hr>
</div>

  <script src="lib/codetabs.js"></script>

</body>
</html>
